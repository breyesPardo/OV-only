function actualizarOrdenesCredito() {
  const hojaOrdenes = "OrdenesRetenidas";
  const hojaLogs = "LogsLiberaciones";
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // Crear hojas si no existen
  let sheetOrdenes = ss.getSheetByName(hojaOrdenes);
  if (!sheetOrdenes) sheetOrdenes = ss.insertSheet(hojaOrdenes);
  else sheetOrdenes.clear();

  let sheetLogs = ss.getSheetByName(hojaLogs);
  if (!sheetLogs) sheetLogs = ss.insertSheet(hojaLogs);
  else sheetLogs.clear();

  // Encabezados para hoja OrdenesRetenidas
  sheetOrdenes.getRange(1, 1, 1, 7).setValues([[
    "OrderNum", "Fecha", "Zona", "Cliente", "Estado", "Motivo Retención", "Observaciones Retención"
  ]]);

  // Encabezados para hoja LogsLiberaciones
  sheetLogs.getRange(1, 1, 1, 8).setValues([[
    "OrderNum", "Zona", "Cliente", "Fecha Liberación", "Hora Liberación", "UsuarioID", "Nombre Usuario", "Observaciones"
  ]]);

  // Conexión a SQL Server
  const conn = Jdbc.getConnection(
    "jdbc:sqlserver://35.243.175.82:1433;databaseName=EpicorRepTran",
    "udlxls",
    "#kYe-343"
  );

  // Consulta de órdenes retenidas no liberadas
  const queryRetenidas = `
    SELECT 
      d.OrderHed_OrderNum,
      d.OrderHed_OrderDate,
      d.Zona,
      d.Customer_Name,
      d.OrderHed_OrderHeld,
      d.CreditoRetenido,
      d.ObservacionesRetencionCredito
    FROM EpicorRepTran.dbo.udvPortalCustDtlOV d
    LEFT JOIN Erp.OrderHed o ON d.OrderHed_OrderNum = o.OrderNum
    WHERE 
      d.CreditoRetenido = 1 
      AND d.OrderHed_VoidOrder = 0 
      AND d.Zona != 'Comercial Agrosoil'
      AND (o.CreditOverride IS NULL OR o.CreditOverride = 0)
  `;

  // Consulta de órdenes ya liberadas
  const queryLiberadas = `
    SELECT 
      d.OrderHed_OrderNum,
      d.Zona,
      d.Customer_Name,
      o.CreditOverrideDate,
      o.CreditOverrideTime,
      o.CreditOverrideUserID,
      u.Name AS NombreUsuario,
      d.ObservacionesRetencionCredito
    FROM EpicorRepTran.dbo.udvPortalCustDtlOV d
    JOIN Erp.OrderHed o ON d.OrderHed_OrderNum = o.OrderNum
    LEFT JOIN Ice.SysUserFile u ON o.CreditOverrideUserID = u.UserID
    WHERE 
      d.CreditoRetenido = 1 
      AND d.OrderHed_VoidOrder = 0 
      AND d.Zona != 'Comercial Agrosoil'
      AND o.CreditOverride = 1
  `;

  // Cargar resultados de órdenes retenidas
  const stmt1 = conn.createStatement();
  const results1 = stmt1.executeQuery(queryRetenidas);
  const data1 = [];

  while (results1.next()) {
    let fechaOrden = "";
    try {
      const fechaRaw = results1.getString("OrderHed_OrderDate");
      if (fechaRaw) {
        const fechaObj = new Date(fechaRaw);
        if (fechaObj instanceof Date && !isNaN(fechaObj)) {
          fechaOrden = Utilities.formatDate(fechaObj, Session.getScriptTimeZone(), "dd/MM/yyyy");
        }
      }
    } catch (e) {
      fechaOrden = "";
    }

    data1.push([
      results1.getString("OrderHed_OrderNum"),
      fechaOrden,
      results1.getString("Zona"),
      results1.getString("Customer_Name"),
      "RETENIDA",
      "CRÉDITO",
      results1.getString("ObservacionesRetencionCredito")
    ]);
  }

  if (data1.length > 0) {
    sheetOrdenes.getRange(2, 1, data1.length, 7).setValues(data1);
  }

  // Cargar resultados de logs de liberación
  const stmt2 = conn.createStatement();
  const results2 = stmt2.executeQuery(queryLiberadas);
  const data2 = [];

  while (results2.next()) {
    let fechaLiberacion = "";
    try {
      const fechaRaw = results2.getString("CreditOverrideDate");
      if (fechaRaw) {
        const fechaObj = new Date(fechaRaw);
        if (fechaObj instanceof Date && !isNaN(fechaObj)) {
          fechaLiberacion = Utilities.formatDate(fechaObj, Session.getScriptTimeZone(), "dd/MM/yyyy");
        }
      }
    } catch (e) {
      fechaLiberacion = "";
    }

    data2.push([
      results2.getString("OrderHed_OrderNum"),
      results2.getString("Zona"),
      results2.getString("Customer_Name"),
      fechaLiberacion,
      results2.getString("CreditOverrideTime"),
      results2.getString("CreditOverrideUserID"),
      results2.getString("NombreUsuario"),
      results2.getString("ObservacionesRetencionCredito")
    ]);
  }

  if (data2.length > 0) {
    sheetLogs.getRange(2, 1, data2.length, 8).setValues(data2);
  }

  stmt1.close(); stmt2.close(); conn.close();
}
